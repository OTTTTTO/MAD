<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MAD è¯Šæ–­å·¥å…·</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
    }
    h1 { color: #333; margin-bottom: 20px; }
    h2 { color: #666; margin: 20px 0 10px; font-size: 18px; }
    .status {
      padding: 10px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .status.success { background: #d4edda; color: #155724; }
    .status.error { background: #f8d7da; color: #721c24; }
    .status.info { background: #d1ecf1; color: #0c5460; }
    pre {
      background: #f5f5f5;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
      font-size: 13px;
      max-height: 300px;
      overflow-y: auto;
    }
    .discussion-list {
      margin-top: 20px;
    }
    .discussion-item {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 6px;
      margin-bottom: 10px;
      background: #f9f9f9;
    }
    .discussion-item h3 {
      font-size: 16px;
      color: #333;
      margin-bottom: 8px;
    }
    .meta {
      font-size: 13px;
      color: #666;
      display: flex;
      gap: 15px;
    }
    .badge {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .badge.active { background: #28a745; color: white; }
    .badge.ended { background: #6c757d; color: white; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      margin-right: 10px;
    }
    button:hover { background: #5568d3; }
    .error-log {
      background: #f8d7da;
      color: #721c24;
      padding: 15px;
      border-radius: 6px;
      margin-top: 20px;
      font-family: monospace;
      font-size: 12px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ” MAD è®¨è®ºç»„è¯Šæ–­å·¥å…·</h1>

    <div id="apiStatus" class="status info">æ­£åœ¨æ£€æŸ¥ API è¿æ¥...</div>

    <div>
      <button onclick="testAPI()">ğŸ” æµ‹è¯• API è¿æ¥</button>
      <button onclick="loadDiscussions()">ğŸ“‹ åŠ è½½è®¨è®ºåˆ—è¡¨</button>
      <button onclick="clearBrowserData()">ğŸ—‘ï¸ æ¸…é™¤æµè§ˆå™¨æ•°æ®</button>
    </div>

    <div id="errorLog" class="error-log"></div>

    <h2>API å“åº”ç¤ºä¾‹ï¼ˆç¬¬ä¸€ä¸ªè®¨è®ºï¼‰</h2>
    <pre id="apiResponse">ç­‰å¾…æµ‹è¯•...</pre>

    <h2>è®¨è®ºåˆ—è¡¨ (<span id="discussionCount">0</span> ä¸ª)</h2>
    <div id="discussionList" class="discussion-list">
      <div style="padding: 20px; text-align: center; color: #999;">
        ç‚¹å‡»"åŠ è½½è®¨è®ºåˆ—è¡¨"æŒ‰é’®å¼€å§‹æµ‹è¯•
      </div>
    </div>

    <h2>æµè§ˆå™¨ä¿¡æ¯</h2>
    <pre id="browserInfo"></pre>
  </div>

  <script>
    const API_BASE = 'http://localhost:18790';

    // æ˜¾ç¤ºæµè§ˆå™¨ä¿¡æ¯
    document.getElementById('browserInfo').textContent = `
User Agent: ${navigator.userAgent}
è¯­è¨€: ${navigator.language}
Cookie å¯ç”¨: ${navigator.cookieEnabled}
åœ¨çº¿çŠ¶æ€: ${navigator.onLine ? 'æ˜¯' : 'å¦'}
    `.trim();

    function logError(message) {
      const errorLog = document.getElementById('errorLog');
      errorLog.style.display = 'block';
      errorLog.textContent += `[${new Date().toLocaleTimeString()}] ${message}\n`;
    }

    function updateStatus(message, type = 'info') {
      const statusEl = document.getElementById('apiStatus');
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
    }

    async function testAPI() {
      try {
        updateStatus('æ­£åœ¨æµ‹è¯• API...', 'info');
        document.getElementById('apiResponse').textContent = 'åŠ è½½ä¸­...';

        const response = await fetch(`${API_BASE}/api/discussions`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        document.getElementById('apiResponse').textContent = JSON.stringify(data[0], null, 2);
        updateStatus(`âœ… API è¿æ¥æˆåŠŸï¼è¿”å› ${data.length} ä¸ªè®¨è®º`, 'success');

      } catch (error) {
        document.getElementById('apiResponse').textContent = `é”™è¯¯: ${error.message}`;
        updateStatus(`âŒ API è¿æ¥å¤±è´¥: ${error.message}`, 'error');
        logError(`API æµ‹è¯•å¤±è´¥: ${error.message}`);
      }
    }

    async function loadDiscussions() {
      try {
        updateStatus('æ­£åœ¨åŠ è½½è®¨è®ºåˆ—è¡¨...', 'info');
        const response = await fetch(`${API_BASE}/api/discussions`);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const discussions = await response.json();

        document.getElementById('discussionCount').textContent = discussions.length;

        const listHTML = discussions.map(d => `
          <div class="discussion-item">
            <h3>${escapeHtml(d.topic || 'æ— æ ‡é¢˜')}</h3>
            <div class="meta">
              <span class="badge ${d.status}">${d.status === 'active' ? 'è¿›è¡Œä¸­' : 'å·²ç»“æŸ'}</span>
              <span>ğŸ’¬ ${d.messageCount} æ¡æ¶ˆæ¯</span>
              <span>ğŸ‘¥ ${d.participants} äºº</span>
              <span>â±ï¸ ${formatDuration(d.duration)}</span>
            </div>
          </div>
        `).join('');

        document.getElementById('discussionList').innerHTML = listHTML;
        updateStatus(`âœ… æˆåŠŸåŠ è½½ ${discussions.length} ä¸ªè®¨è®º`, 'success');

      } catch (error) {
        document.getElementById('discussionList').innerHTML = `
          <div style="padding: 20px; text-align: center; color: #721c24;">
            âŒ åŠ è½½å¤±è´¥: ${error.message}
          </div>
        `;
        updateStatus(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        logError(`åŠ è½½è®¨è®ºå¤±è´¥: ${error.message}`);
      }
    }

    function formatDuration(ms) {
      if (!ms) return 'æœªçŸ¥';
      const seconds = Math.floor(ms / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}å¤©${hours % 24}å°æ—¶`;
      if (hours > 0) return `${hours}å°æ—¶${minutes % 60}åˆ†é’Ÿ`;
      if (minutes > 0) return `${minutes}åˆ†é’Ÿ`;
      return `${seconds}ç§’`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function clearBrowserData() {
      if (confirm('ç¡®å®šè¦æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å—ï¼Ÿè¿™å°†åˆ·æ–°é¡µé¢ã€‚')) {
        if ('caches' in window) {
          caches.keys().then(names => {
            names.forEach(name => caches.delete(name));
          });
        }
        location.reload(true);
      }
    }

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æµ‹è¯•
    window.addEventListener('load', () => {
      testAPI();
      loadDiscussions();
    });
  </script>
</body>
</html>
