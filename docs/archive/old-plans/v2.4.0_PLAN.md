# MAD v2.4.0 开发计划

**计划时间：** 2026-02-02
**目标版本：** v2.4.0
**前一版本：** v2.3.0

---

## 🎯 版本目标

v2.4.0 将引入讨论版本控制功能，让用户可以追踪讨论的历史变化，重点关注：

1. **讨论快照** - 保存讨论的历史版本
2. **版本比较** - 比较不同版本的差异
3. **版本恢复** - 恢复到历史版本
4. **版本分支** - 创建讨论分支

---

## 📋 功能清单

### 1. 讨论快照
- [ ] 自动快照
  - 定时自动保存快照
  - 关键节点自动快照（讨论结束、共识达成）
  - 快照压缩存储
- [ ] 手动快照
  - 用户手动创建快照
  - 快照描述和标签
  - 快照命名
- [ ] 快照管理
  - 快照列表
  - 快照搜索
  - 快照删除

### 2. 版本比较
- [ ] 差异显示
  - 消息级差异
  - 内容级差异（字符级）
  - 可视化 diff
- [ ] 比较视图
  - 并排比较
  - 统一比较
  - 变更统计
- [ ] 变更高亮
  - 新增消息（绿色）
  - 删除消息（红色）
  - 修改消息（黄色）

### 3. 版本恢复
- [ ] 恢复功能
  - 恢复到指定版本
  - 预览恢复效果
  - 恢复确认
- [ ] 恢复选项
  - 完全恢复
  - 选择性恢复
  - 合并恢复
- [ ] 恢复历史
  - 恢复记录
  - 恢复时间线

### 4. 版本分支
- [ ] 创建分支
  - 从快照创建分支
  - 分支命名
  - 分支描述
- [ ] 分支管理
  - 分支列表
  - 分支切换
  - 分支合并
  - 分支删除
- [ ] 分支比较
  - 比较分支差异
  - 合并预览

---

## 🔧 技术实现

### 快照存储结构

```javascript
/**
 * 讨论快照
 */
{
  "id": "snap-001",
  "discussionId": "disc-001",
  "version": 1,
  "timestamp": "2026-02-02T10:00:00.000Z",
  "type": "auto|manual",
  "description": "自动快照 - 讨论结束",
  "tags": ["结束", "共识"],
  "messageCount": 25,
  "participants": ["coordinator", "technical"],
  "data": {
    "messages": [...],
    "context": {...}
  },
  "compression": "gzip"
}
```

### 版本比较算法

```javascript
/**
 * 比较两个版本
 */
function compareVersions(version1, version2) {
  const changes = {
    added: [],      // 新增的消息
    removed: [],    // 删除的消息
    modified: []    // 修改的消息
  };

  // 比较消息列表
  const messages1 = new Map(version1.messages.map(m => [m.id, m]));
  const messages2 = new Map(version2.messages.map(m => [m.id, m]));

  // 检查新增和删除
  version2.messages.forEach(msg2 => {
    if (!messages1.has(msg2.id)) {
      changes.added.push(msg2);
    } else {
      const msg1 = messages1.get(msg2.id);
      if (msg1.content !== msg2.content) {
        changes.modified.push({
          id: msg2.id,
          old: msg1,
          new: msg2
        });
      }
    }
  });

  version1.messages.forEach(msg1 => {
    if (!messages2.has(msg1.id)) {
      changes.removed.push(msg1);
    }
  });

  return changes;
}
```

### API 设计

```
# 快照管理
POST /api/discussion/:id/snapshot
Body: { description, tags, type }
Response: { snapshotId, version }

GET /api/discussion/:id/snapshots
Response: { snapshots: [...] }

GET /api/snapshot/:id
Response: { snapshot }

DELETE /api/snapshot/:id

# 版本比较
GET /api/discussion/:id/compare
Query: ?from=version1&to=version2
Response: { changes: {...} }

# 版本恢复
POST /api/discussion/:id/restore
Body: { snapshotId, mode }
Response: { success }

# 分支管理
POST /api/discussion/:id/branch
Body: { snapshotId, name, description }
Response: { branchId }

GET /api/discussion/:id/branches
Response: { branches: [...] }

POST /api/branch/:id/merge
Body: { sourceBranchId }
Response: { success, conflicts }
```

---

## 📂 文件结构

```
mad/
├── version/                     # 新增：版本控制模块
│   ├── snapshot.js              # 快照管理
│   ├── diff.js                  # 版本比较
│   ├── restore.js               # 版本恢复
│   └── branch.js                # 分支管理
├── snapshots/                   # 新增：快照存储目录
│   └── .gitkeep
├── branches/                    # 新增：分支存储目录
│   └── .gitkeep
├── web/
│   ├── server.js                # 添加版本控制 API
│   └── public/
│       ├── index.html           # 添加版本控制 UI
│       ├── app.js               # 添加版本控制逻辑
│       └── style.css            # 添加版本控制样式
└── VERSION_PLANS/
    └── v2.4.0_PLAN.md           # 本文件
```

---

## 🚀 开发步骤

### 阶段 1：讨论快照（2-3 小时）
1. ✅ 创建 `version/snapshot.js`
2. ✅ 实现快照创建
3. ✅ 实现快照存储
4. ✅ 实现快照列表
5. ✅ 添加快照 API
6. ✅ 添加快照 UI
7. ✅ 测试功能
8. ✅ 提交代码：`feat: v2.4.0 - 讨论快照`

### 阶段 2：版本比较（2-3 小时）
1. ✅ 创建 `version/diff.js`
2. ✅ 实现版本比较算法
3. ✅ 实现差异显示
4. ✅ 添加比较 API
5. ✅ 添加比较 UI（并排视图、统一视图）
6. ✅ 测试功能
7. ✅ 提交代码：`feat: v2.4.0 - 版本比较`

### 阶段 3：版本恢复（1-2 小时）
1. ✅ 创建 `version/restore.js`
2. ✅ 实现恢复逻辑
3. ✅ 实现预览功能
4. ✅ 添加恢复 API
5. ✅ 添加恢复 UI
6. ✅ 测试功能
7. ✅ 提交代码：`feat: v2.4.0 - 版本恢复`

### 阶段 4：版本分支（2-3 小时）
1. ✅ 创建 `version/branch.js`
2. ✅ 实现分支创建
3. ✅ 实现分支管理
4. ✅ 实现分支合并
5. ✅ 添加分支 API
6. ✅ 添加分支 UI
7. ✅ 测试功能
8. ✅ 提交代码：`feat: v2.4.0 - 版本分支`

### 阶段 5：整合和发布（30 分钟）
1. ✅ 更新 package.json 到 v2.4.0
2. ✅ 更新 README.md 版本历史
3. ✅ 整理代码注释
4. ✅ 最终测试
5. ✅ 提交：`chore: bump version to v2.4.0`
6. ✅ 推送到 GitHub

### 阶段 6：规划 v2.5.0（30 分钟）
1. ✅ 创建 v2.5.0_PLAN.md
2. ✅ 规划新功能
3. ✅ 继续迭代...

---

## 📊 预期成果

### v2.4.0 完成后
- ✅ 讨论快照功能
- ✅ 版本比较和差异显示
- ✅ 版本恢复
- ✅ 版本分支管理
- ✅ 完整的版本控制系统

### 新增 API
- `POST /api/discussion/:id/snapshot` - 创建快照
- `GET /api/discussion/:id/snapshots` - 获取快照列表
- `GET /api/snapshot/:id` - 获取快照详情
- `DELETE /api/snapshot/:id` - 删除快照
- `GET /api/discussion/:id/compare` - 比较版本
- `POST /api/discussion/:id/restore` - 恢复版本
- `POST /api/discussion/:id/branch` - 创建分支
- `GET /api/discussion/:id/branches` - 获取分支列表
- `POST /api/branch/:id/merge` - 合并分支

### 新增模块
- `version/snapshot.js` - 快照管理
- `version/diff.js` - 版本比较
- `version/restore.js` - 版本恢复
- `version/branch.js` - 分支管理

---

## 💡 技术亮点

1. **快照压缩** - 高效的存储
2. **智能 Diff** - 精确的差异检测
3. **可视化比较** - 清晰的变更展示
4. **安全恢复** - 预览 + 确认机制
5. **分支管理** - Git 风格的分支系统

---

## 🎉 版本口号

> **v2.4.0：让讨论可追溯，让版本可管理**

---

**开始时间：** 2026-02-02
**预计完成：** 2026-02-02
**开发者：** OpenClaw Agent Team
