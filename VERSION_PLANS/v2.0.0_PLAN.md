# MAD v2.0.0 开发计划

**计划时间：** 2026-02-02
**目标版本：** v2.0.0
**前一版本：** v1.9.0

---

## 🎯 版本目标

v2.0.0 将是一个重大版本更新，引入 3 个核心功能：

1. **讨论模板市场** - 用户可以分享和下载模板
2. **Agent 自定义** - 用户可以创建自己的 Agent 角色
3. **讨论相似度检测** - 文本向量化 + 余弦相似度（完成 v1.9.0 剩余）

---

## 📋 功能清单

### 0. 完成 v1.9.0 剩余功能
- [x] 智能推荐参与者
- [x] 讨论转待办事项
- [ ] **讨论相似度检测**
  - 文本向量化算法（TF-IDF 或词向量）
  - 余弦相似度计算
  - 相似讨论面板
  - 合并讨论功能

### 1. 讨论模板市场
- [ ] 模板分享功能
  - 导出模板为 JSON
  - 上传到 GitHub（或本地市场）
  - 模板元数据（名称、描述、标签、作者）
- [ ] 模板浏览和搜索
  - 模板列表页面
  - 按标签过滤
  - 搜索功能
- [ ] 模板下载和应用
  - 一键下载模板
  - 预览模板配置
  - 应用到新讨论
- [ ] 模板评分和评论
  - 星级评分
  - 用户评论
  - 使用统计

### 2. Agent 自定义
- [ ] Agent 创建界面
  - 名称和头像
  - 系统提示词编辑器
  - 专长标签设置
  - 性格参数（开放性、严谨性等）
- [ ] Agent 管理功能
  - 查看、编辑、删除自定义 Agent
  - 启用/禁用 Agent
  - Agent 导入/导出
- [ ] Agent 验证
  - 提示词语法检查
  - 参数验证
  - 测试对话
- [ ] Agent 市场
  - 社区分享的 Agent
  - 一键安装
  - Agent 评分

### 3. 讨论相似度检测（v1.9.0 剩余）
- [ ] 文本预处理
  - 分词（中文 + 英文）
  - 停用词过滤
  - 词干提取（英文）
- [ ] 向量化算法
  - TF-IDF 向量
  - 或词向量平均（Word2Vec/GloVe）
- [ ] 相似度计算
  - 余弦相似度
  - 相似度阈值（0-1）
- [ ] 相似讨论面板
  - 显示相似讨论列表
  - 相似度百分比
  - 快速跳转
- [ ] 合并讨论功能
  - 选择多个讨论
  - 合并消息历史
  - 保留元数据

---

## 🔧 技术实现

### 讨论相似度检测

#### 1. 文本向量化（TF-IDF）
```javascript
class TextVectorizer {
  // 构建 TF-IDF 模型
  buildModel(texts) {
    // 分词
    // 计算 TF
    // 计算 IDF
    // 返回词汇表和 IDF 向量
  }

  // 将文本转换为向量
  vectorize(text, model) {
    // 计算 TF
    // 乘以 IDF
    // 归一化
  }

  // 计算余弦相似度
  cosineSimilarity(vec1, vec2) {
    // 点积 / (模长1 * 模长2)
  }
}
```

#### 2. 相似讨论查找
```javascript
findSimilarDiscussions(discussionId, threshold = 0.3) {
  // 获取目标讨论
  // 提取所有消息文本
  // 向量化
  // 与所有其他讨论比较
  // 返回相似度 > threshold 的讨论
}
```

#### 3. API 设计
```
GET /api/discussion/:id/similar
Response: {
  similar: [
    {
      discussionId: "...",
      topic: "...",
      similarity: 0.75,
      commonKeywords: ["关键词1", "关键词2"]
    }
  ]
}

POST /api/discussion/:id/merge
Body: {
  sourceIds: ["id1", "id2"]
}
```

### 讨论模板市场

#### 1. 模板格式
```json
{
  "id": "template-001",
  "name": "代码评审模板",
  "description": "用于代码评审的讨论模板",
  "tags": ["技术", "评审", "代码"],
  "author": "张三",
  "version": "1.0.0",
  "createdAt": "2026-02-02",
  "config": {
    "topic": "代码评审：{repo}#{pr}",
    "participants": ["technical", "testing"],
    "maxRounds": 5,
    "promptTemplate": "请从以下角度评审 PR：..."
  }
}
```

#### 2. 模板市场数据结构
```json
{
  "templates": [
    { /* 模板1 */ },
    { /* 模板2 */ }
  ],
  "categories": ["需求", "技术", "市场", "综合"],
  "stats": {
    "totalDownloads": 1234,
    "topRated": [...]
  }
}
```

#### 3. API 设计
```
GET /api/templates
Response: { templates: [...] }

POST /api/template
Body: { templateData }
Response: { id, url }

GET /api/template/:id
Response: { template }

POST /api/template/:id/rate
Body: { rating: 5, comment: "..." }
```

### Agent 自定义

#### 1. Agent 定义格式
```json
{
  "id": "custom-001",
  "name": "安全专家",
  "emoji": "🔒",
  "systemPrompt": "...",
  "expertise": ["安全", "漏洞", "加密"],
  "personality": {
    "openness": 0.8,
    "rigor": 0.9,
    "creativity": 0.6
  },
  "custom": true,
  "author": "用户名",
  "createdAt": "2026-02-02"
}
```

#### 2. Agent 存储
- 文件：`agents/custom/` 目录
- 格式：JSON 文件
- 加载：启动时动态加载

#### 3. API 设计
```
GET /api/agents/custom
Response: { agents: [...] }

POST /api/agents/custom
Body: { agentData }
Response: { id }

PUT /api/agents/custom/:id
Body: { agentData }

DELETE /api/agents/custom/:id

POST /api/agents/custom/:id/test
Body: { message }
Response: { response }
```

---

## 📂 文件结构

```
mad/
├── orchestrator.js              # 添加相似度检测算法
├── similarity.js                # 新增：文本向量和相似度计算
├── web/
│   ├── server.js                # 添加相似度、模板、Agent API
│   ├── websocket.js             # (无变化)
│   └── public/
│       ├── index.html           # 添加模板市场和 Agent 自定义 UI
│       ├── app.js               # 添加新功能的前端逻辑
│       └── style.css            # 添加新样式
├── agents/
│   └── custom/                  # 新增：自定义 Agent 目录
│       ├── security-expert.json
│       └── ...
├── templates/
│   ├── templates.json           # 现有模板
│   └── market.json              # 新增：模板市场
└── VERSION_PLANS/
    └── v2.0.0_PLAN.md           # 本文件
```

---

## 🚀 开发步骤

### 阶段 1：完成 v1.9.0 相似度检测（1-2 小时）
1. ✅ 创建 `similarity.js` 模块
2. ✅ 实现分词（中文 + 英文）
3. ✅ 实现 TF-IDF 向量化
4. ✅ 实现余弦相似度计算
5. ✅ 在 `orchestrator.js` 中集成
6. ✅ 在 `web/server.js` 中添加 API
7. ✅ 在 `web/public/app.js` 中添加 UI
8. ✅ 在 `web/public/style.css` 中添加样式
9. ✅ 在 `web/public/index.html` 中添加按钮
10. ✅ 测试功能
11. ✅ 提交代码：`feat: v1.9.0 - 完成相似度检测`

### 阶段 2：讨论模板市场（2-3 小时）
1. ✅ 设计模板市场数据结构
2. ✅ 创建 `templates/market.json`
3. ✅ 实现模板 API（浏览、搜索、下载）
4. ✅ 创建模板市场 UI
5. ✅ 实现模板分享功能
6. ✅ 实现模板评分功能
7. ✅ 测试功能
8. ✅ 更新 README.md
9. ✅ 提交代码：`feat: v2.0.0 - 讨论模板市场`

### 阶段 3：Agent 自定义（2-3 小时）
1. ✅ 创建 `agents/custom/` 目录
2. ✅ 设计自定义 Agent 数据结构
3. ✅ 实现 Agent API（CRUD）
4. ✅ 创建 Agent 创建/编辑 UI
5. ✅ 实现 Agent 测试功能
6. ✅ 集成到讨论系统
7. ✅ 测试功能
8. ✅ 更新 README.md
9. ✅ 提交代码：`feat: v2.0.0 - Agent 自定义`

### 阶段 4：整合和发布（30 分钟）
1. ✅ 更新 package.json 到 v2.0.0
2. ✅ 更新 README.md 版本历史
3. ✅ 整理代码注释
4. ✅ 最终测试
5. ✅ 提交：`chore: bump version to v2.0.0`
6. ✅ 推送到 GitHub

### 阶段 5：规划 v2.1.0（30 分钟）
1. ✅ 创建 v2.1.0_PLAN.md
2. ✅ 规划新功能
3. ✅ 继续迭代...

---

## 📊 预期成果

### v1.9.0 完成后
- ✅ 讨论相似度检测功能
- ✅ 相似讨论面板
- ✅ 合并讨论功能

### v2.0.0 完成后
- ✅ 讨论模板市场（20+ 预置模板）
- ✅ Agent 自定义系统
- ✅ 用户可以分享和下载模板
- ✅ 用户可以创建自己的 Agent
- ✅ 更强大的讨论能力

### 新增 API
- `/api/discussion/:id/similar` - 获取相似讨论
- `/api/discussion/:id/merge` - 合并讨论
- `/api/templates` - 模板列表
- `/api/template/:id` - 模板详情
- `/api/agents/custom` - 自定义 Agent 列表
- `/api/agents/custom/:id` - Agent 详情

---

## 💡 技术亮点

1. **TF-IDF 向量化** - 轻量级文本相似度算法
2. **模板市场** - 社区驱动的内容生态
3. **Agent 自定义** - 用户可定制的 AI 角色
4. **插件化架构** - 易于扩展和维护

---

## 🎉 版本口号

> **v2.0.0：让讨论更智能，让 Agent 更个性**

---

**开始时间：** 2026-02-02
**预计完成：** 2026-02-02
**开发者：** OpenClaw Agent Team
