# MAD v2.3.0 开发计划

**计划时间：** 2026-02-02
**目标版本：** v2.3.0
**前一版本：** v2.2.0

---

## 🎯 版本目标

v2.3.0 将在 v2.2.0 的基础上引入实时协作编辑功能，重点关注：

1. **实时编辑器** - 多人同时编辑讨论内容
2. **协作光标** - 显示其他用户的编辑位置
3. **变更追踪** - 实时显示编辑变更
4. **冲突解决** - 处理编辑冲突

---

## 📋 功能清单

### 1. 实时编辑器
- [ ] 富文本编辑器
  - 支持 Markdown 编辑
  - 实时预览
  - 语法高亮
  - 代码块支持
- [ ] 实时同步
  - WebSocket 实时通信
  - 操作转换（OT）算法
  - 增量同步
  - 断线重连
- [ ] 编辑器集成
  - Monaco Editor 或 CodeMirror
  - 自定义主题
  - 快捷键支持
  - 自动保存

### 2. 协作光标
- [ ] 光标显示
  - 显示其他用户的光标位置
  - 用户颜色标识
  - 用户名称标签
  - 光标跟随
- [ ] 选择范围
  - 显示其他用户的选区
  - 高亮显示
  - 多用户同时选择
- [ ] 远程光标管理
  - 添加/移除远程光标
  - 光标位置同步
  - 性能优化

### 3. 变更追踪
- [ ] 实时变更
  - 显示字符级变更
  - 插入/删除标记
  - 变更动画
  - 变更历史
- [ ] 作者追踪
  - 显示编辑作者
  - 作者颜色
  - 时间戳
- [ ] 变更面板
  - 显示最近的变更
  - 变更统计
  - 回滚功能

### 4. 冲突解决
- [ ] 冲突检测
  - 检测同时编辑
  - 冲突警告
  - 冲突标记
- [ ] 冲突解决
  - 自动合并
  - 手动解决
  - 版本比较
- [ ] 冲突通知
  - 实时通知
  - 冲突预览
  - 解决建议

---

## 🔧 択术实现

### 操作转换（OT）算法

```javascript
/**
 * 操作类型
 */
const OperationType = {
  INSERT: 'insert',
  DELETE: 'delete',
  RETAIN: 'retain'
};

/**
 * 操作
 */
class Operation {
  constructor(type, content, position, author) {
    this.type = type;
    this.content = content;
    this.position = position;
    this.author = author;
    this.timestamp = Date.now();
  }
}

/**
 * 操作转换（Transform）
 */
function transform(op1, op2) {
  // 基于 OT 算法转换两个操作
  // 使它们可以按任意顺序应用而得到相同结果
  if (op1.type === OperationType.INSERT && op2.type === OperationType.INSERT) {
    if (op1.position <= op2.position) {
      return {
        op1: op1,
        op2: { ...op2, position: op2.position + op1.content.length }
      };
    } else {
      return {
        op1: { ...op1, position: op1.position + op2.content.length },
        op2: op2
      };
    }
  }

  if (op1.type === OperationType.DELETE && op2.type === OperationType.INSERT) {
    if (op1.position < op2.position) {
      return {
        op1: op1,
        op2: { ...op2, position: op2.position - op1.content.length }
      };
    } else {
      return {
        op1: { ...op1, position: op1.position + op2.content.length },
        op2: op2
      };
    }
  }

  // ... 其他情况
}

/**
 * 应用操作
 */
function applyOperation(content, operation) {
  switch (operation.type) {
    case OperationType.INSERT:
      return content.slice(0, operation.position) +
             operation.content +
             content.slice(operation.position);
    case OperationType.DELETE:
      return content.slice(0, operation.position) +
             content.slice(operation.position + operation.content.length);
    default:
      return content;
  }
}
```

### WebSocket 协议

```javascript
// 客户端 → 服务器
{
  "type": "operation",
  "discussionId": "disc-001",
  "operation": {
    "type": "insert",
    "content": "abc",
    "position": 10,
    "author": "user-001"
  }
}

// 服务器 → 客户端
{
  "type": "operation",
  "operation": { ... },
  "version": 123
}

// 光标位置
{
  "type": "cursor",
  "discussionId": "disc-001",
  "userId": "user-002",
  "position": 15,
  "selection": { start: 10, end: 20 }
}
```

### API 设计

```
# 实时编辑
WS /api/realtime/edit/:discussionId

# 获取当前内容
GET /api/discussion/:id/content
Response: {
  content: "...",
  version: 123,
  authors: [...]
}

# 获取变更历史
GET /api/discussion/:id/changes
Query: ?since=123
Response: {
  changes: [...]
}

# 解决冲突
POST /api/discussion/:id/resolve-conflict
Body: {
  baseVersion: 123,
  changes: [...]
}
```

---

## 📂 文件结构

```
mad/
├── realtime/                    # 新增：实时协作模块
│   ├── editor.js                # 编辑器管理
│   ├── operation.js             # 操作转换
│   ├── cursor.js                # 光标管理
│   └── conflict.js              # 冲突解决
├── web/
│   ├── realtime.js              # 新增：WebSocket 实时通信
│   ├── server.js                # 添加实时编辑 API
│   └── public/
│       ├── editor.html          # 新增：编辑器页面
│       ├── editor.js            # 新增：编辑器前端逻辑
│       ├── editor.css           # 新增：编辑器样式
│       ├── index.html           # 添加编辑入口
│       ├── app.js               # 添加编辑功能
│       └── style.css            # 添加编辑器样式
└── VERSION_PLANS/
    └── v2.3.0_PLAN.md           # 本文件
```

---

## 🚀 开发步骤

### 阶段 1：实时编辑器（3-4 小时）
1. ✅ 集成 CodeMirror 或 Monaco Editor
2. ✅ 创建 `realtime/editor.js`
3. ✅ 实现基本编辑功能
4. ✅ 添加 Markdown 支持
5. ✅ 实现语法高亮
6. ✅ 添加自动保存
7. ✅ 测试功能
8. ✅ 提交代码：`feat: v2.3.0 - 实时编辑器`

### 阶段 2：操作转换（2-3 小时）
1. ✅ 创建 `realtime/operation.js`
2. ✅ 实现 OT 算法
3. ✅ 实现操作应用
4. ✅ 实现操作同步
5. ✅ 添加版本管理
6. ✅ 测试功能
7. ✅ 提交代码：`feat: v2.3.0 - 操作转换`

### 阶段 3：协作光标（1-2 小时）
1. ✅ 创建 `realtime/cursor.js`
2. ✅ 实现本地光标追踪
3. ✅ 实现远程光标显示
4. ✅ 添加选择范围显示
5. ✅ 实现光标同步
6. ✅ 测试功能
7. ✅ 提交代码：`feat: v2.3.0 - 协作光标`

### 阶段 4：变更追踪（1-2 小时）
1. ✅ 实现变更记录
2. ✅ 实现实时变更显示
3. ✅ 添加作者追踪
4. ✅ 创建变更面板
5. ✅ 测试功能
6. ✅ 提交代码：`feat: v2.3.0 - 变更追踪`

### 阶段 5：冲突解决（2-3 小时）
1. ✅ 创建 `realtime/conflict.js`
2. ✅ 实现冲突检测
3. ✅ 实现自动合并
4. ✅ 实现手动解决
5. ✅ 添加冲突通知
6. ✅ 测试功能
7. ✅ 提交代码：`feat: v2.3.0 - 冲突解决`

### 阶段 6：整合和发布（30 分钟）
1. ✅ 更新 package.json 到 v2.3.0
2. ✅ 更新 README.md 版本历史
3. ✅ 整理代码注释
4. ✅ 最终测试
5. ✅ 提交：`chore: bump version to v2.3.0`
6. ✅ 推送到 GitHub

### 阶段 7：规划 v2.4.0（30 分钟）
1. ✅ 创建 v2.4.0_PLAN.md
2. ✅ 规划新功能（讨论版本控制）
3. ✅ 继续迭代...

---

## 📊 预期成果

### v2.3.0 完成后
- ✅ 实时协作编辑器
- ✅ 协作光标显示
- ✅ 变更追踪
- ✅ 冲突自动解决
- ✅ 多人实时协作

### 新增 API
- `WS /api/realtime/edit/:discussionId` - WebSocket 实时编辑
- `GET /api/discussion/:id/content` - 获取内容
- `GET /api/discussion/:id/changes` - 获取变更历史
- `POST /api/discussion/:id/resolve-conflict` - 解决冲突

### 新增模块
- `realtime/editor.js` - 编辑器管理
- `realtime/operation.js` - 操作转换
- `realtime/cursor.js` - 光标管理
- `realtime/conflict.js` - 冲突解决
- `web/realtime.js` - WebSocket 通信

---

## 💡 技术亮点

1. **操作转换（OT）** - 支持无冲突的并发编辑
2. **实时同步** - WebSocket 低延迟通信
3. **协作光标** - 清晰显示其他用户位置
4. **智能冲突解决** - 自动合并 + 手动干预
5. **完整的编辑器** - Markdown、语法高亮、快捷键

---

## 🎉 版本口号

> **v2.3.0：让协作更实时，让编辑更流畅**

---

**开始时间：** 2026-02-02
**预计完成：** 2026-02-02
**开发者：** OpenClaw Agent Team
