# MAD v2.2.0 开发计划

**计划时间：** 2026-02-02
**目标版本：** v2.2.0
**前一版本：** v2.1.0

---

## 🎯 版本目标

v2.2.0 将在 v2.1.0 的基础上增强讨论协作功能，重点关注：

1. **@提及功能** - Agent 可以互相提及并通知
2. **回复功能** - 支持消息回复和引用
3. **消息引用** - 显示原始消息上下文
4. **提及通知** - 实时通知被提及的 Agent

---

## 📋 功能清单

### 1. @提及功能
- [ ] @提及语法
  - 支持 `@agentName` 格式
  - 自动补全 Agent 名称
  - 高亮显示 @提及
  - 提及验证（检查 Agent 是否存在）
- [ ] @提及检测
  - 解析消息中的 @提及
  - 提取被提及的 Agent ID
  - 统计提及次数
- [ ] @提及通知
  - 通知被提及的 Agent
  - 提及队列管理
  - 优先发言机会
- [ ] @提及面板
  - 显示谁被提及了
  - 提及消息列表
  - 快速跳转到提及

### 2. 回复功能
- [ ] 消息回复
  - 选择消息进行回复
  - 回复消息格式化
  - 回复链可视化
  - 嵌套回复支持
- [ ] 引用显示
  - 显示被回复的消息内容
  - 引用样式
  - 点击跳转到原始消息
- [ ] 回复通知
  - 通知被回复的 Agent
  - 回复提醒
  - 未读回复标记
- [ ] 回复面板
  - 显示消息的回复列表
  - 回复统计
  - 回复树视图

### 3. 消息引用
- [ ] 引用格式
  - `> 引用文本` 格式
  - 多行引用
  - 引用嵌套
- [ ] 引用高亮
  - 特殊样式显示引用
  - 引用来源标记
  - 引用折叠/展开
- [ ] 引用管理
  - 添加引用按钮
  - 引用编辑器
  - 引用预览

### 4. 协作增强
- [ ] 消息操作
  - 复制消息链接
  - 引用消息
  - 回复消息
    - 举报/标记消息
  - [ ] 消息搜索
    - 搜索包含特定内容的消息
    - 搜索提及
    - 搜索回复
  - [ ] 消息过滤器
    - 只显示包含 @提及的消息
    - 只显示回复
    - 只显示引用

---

## 🔧 技术实现

### @提及解析

```javascript
/**
 * 解析消息中的 @提及
 */
function parseMentions(content) {
  const mentionRegex = /@(\w+)/g;
  const mentions = [];
  let match;

  while ((match = mentionRegex.exec(content)) !== null) {
    mentions.push({
      text: match[0],        // @agentName
      agentName: match[1],   // agentName
      index: match.index,    // 位置
    });
  }

  return mentions;
}

/**
 * 验证 @提及
 */
function validateMentions(mentions, availableAgents) {
  return mentions.map(mention => {
    const agent = availableAgents.find(a =>
      a.name.toLowerCase() === mention.agentName.toLowerCase()
    );

    return {
      ...mention,
      valid: !!agent,
      agentId: agent ? agent.id : null,
      agentName: agent ? agent.name : mention.agentName
    };
  });
}
```

### 回复结构

```javascript
/**
 * 消息结构（扩展）
 */
{
  "id": "msg-001",
  "role": "technical",
  "content": "我同意 @coordinator 的建议",
  "timestamp": 1234567890,
  "mentions": [
    {
      "agentId": "coordinator",
      "agentName": "coordinator",
      "text": "@coordinator"
    }
  ],
  "replyTo": {
    "messageId": "msg-000",
    "agentName": "coordinator",
    "content": "我建议采用方案 A"
  },
  "quotes": [
    {
      "text": "引用的文本",
      "sourceMessageId": "msg-000"
    }
  ]
}
```

### 回复链可视化

```javascript
/**
 * 获取消息的回复树
 */
function getReplyTree(messages, rootMessageId) {
  const tree = {
    message: getMessage(rootMessageId),
    replies: []
  };

  // 查找直接回复
  const directReplies = messages.filter(m =>
    m.replyTo && m.replyTo.messageId === rootMessageId
  );

  // 递归查找子回复
  tree.replies = directReplies.map(reply => ({
    message: reply,
    replies: getReplyTree(messages, reply.id).replies
  }));

  return tree;
}
```

### API 设计

```
# @提及相关
POST /api/discussion/:id/mention
Body: {
  messageId: "...",
  agentId: "..."
}
Response: { success: true }

GET /api/discussion/:id/mentions
Response: {
  mentions: [
    {
      messageId: "...",
      fromAgent: "...",
      toAgent: "...",
      timestamp: 1234567890
    }
  ]
}

# 回复相关
POST /api/discussion/:id/reply
Body: {
  messageId: "...",     // 被回复的消息
  content: "...",       // 回复内容
  agentId: "..."        // 回复的 Agent
}

GET /api/message/:id/replies
Response: {
  replies: [...]  // 回复列表
}

# 消息搜索
GET /api/discussion/:id/messages/search
Query: ?q=关键词&type=mention|reply|quote
Response: {
  results: [...]
}
```

---

## 📂 文件结构

```
mad/
├── orchestrator.js              # 添加 @提及和回复逻辑
├── mention.js                   # 新增：@提及解析和处理
├── reply.js                     # 新增：回复管理
├── web/
│   ├── server.js                # 添加 @提及、回复 API
│   └── public/
│       ├── index.html           # 添加回复和引用 UI
│       ├── app.js               # 添加前端逻辑
│       └── style.css            # 添加样式
└── VERSION_PLANS/
    └── v2.2.0_PLAN.md           # 本文件
```

---

## 🚀 开发步骤

### 阶段 1：@提及功能（2-3 小时）
1. ✅ 创建 `mention.js` 模块
2. ✅ 实现 @提及解析
3. ✅ 实现 @提及验证
4. ✅ 在 `orchestrator.js` 中集成
5. ✅ 在消息中存储 @提及数据
6. ✅ 在前端显示 @提及
7. ✅ 测试功能
8. ✅ 提交代码：`feat: v2.2.0 - @提及功能`

### 阶段 2：回复功能（2-3 小时）
1. ✅ 创建 `reply.js` 模块
2. ✅ 实现回复数据结构
3. ✅ 实现回复链管理
4. ✅ 在 `orchestrator.js` 中集成
5. ✅ 在后端添加回复 API
6. ✅ 在前端添加回复 UI
7. ✅ 实现回复可视化
8. ✅ 测试功能
9. ✅ 提交代码：`feat: v2.2.0 - 回复功能`

### 阶段 3：消息引用（1-2 小时）
1. ✅ 实现引用解析
2. ✅ 实现引用高亮
3. ✅ 在前端显示引用
4. ✅ 添加引用按钮
5. ✅ 测试功能
6. ✅ 提交代码：`feat: v2.2.0 - 消息引用`

### 阶段 4：协作增强（1-2 小时）
1. ✅ 实现消息操作（复制链接、引用、回复）
2. ✅ 实现消息搜索
3. ✅ 实现消息过滤器
4. ✅ 添加通知面板
5. ✅ 测试功能
6. ✅ 提交代码：`feat: v2.2.0 - 协作增强`

### 阶段 5：整合和发布（30 分钟）
1. ✅ 更新 package.json 到 v2.2.0
2. ✅ 更新 README.md 版本历史
3. ✅ 整理代码注释
4. ✅ 最终测试
5. ✅ 提交：`chore: bump version to v2.2.0`
6. ✅ 推送到 GitHub

### 阶段 6：规划 v2.3.0（30 分钟）
1. ✅ 创建 v2.3.0_PLAN.md
2. ✅ 规划新功能（实时协作编辑）
3. ✅ 继续迭代...

---

## 📊 预期成果

### v2.2.0 完成后
- ✅ @提及功能（自动补全、验证、通知）
- ✅ 回复功能（回复链、可视化）
- ✅ 消息引用（引用样式、高亮）
- ✅ 协作增强（消息操作、搜索、过滤）
- ✅ 更强的 Agent 协作能力

### 新增 API
- `POST /api/discussion/:id/mention` - 发送提及
- `GET /api/discussion/:id/mentions` - 获取提及列表
- `POST /api/discussion/:id/reply` - 回复消息
- `GET /api/message/:id/replies` - 获取回复列表
- `GET /api/discussion/:id/messages/search` - 搜索消息

### 新增模块
- `mention.js` - @提及管理
- `reply.js` - 回复管理

---

## 💡 技术亮点

1. **智能 @提及** - 自动补全和验证
2. **回复链可视化** - 清晰的消息层级
3. **消息引用** - 优雅的引用样式
4. **实时通知** - 被提及时立即通知
5. **强大的搜索** - 支持多种搜索类型

---

## 🎉 版本口号

> **v2.2.0：让讨论更协作，让沟通更高效**

---

**开始时间：** 2026-02-02
**预计完成：** 2026-02-02
**开发者：** OpenClaw Agent Team
